# -*- coding: utf8
from __future__ import division, print_function

from scipy.signal._peak_finding import _filter_ridge_lines 
from scipy.signal._peak_finding import _identify_ridge_lines

from scipy.signal.wavelets import cwt
from scipy.signal.wavelets import ricker #the mexican hat is aka ricker

import numpy as np

def find_peaks(data, widths=[1, 2, 7, 30, 182, 365]):
    '''
    Finds the peaks using the CWTFindPeaks algorithm. This code is mostly a line
    by line port of the scipy.signal.wavelets.find_peaks_cwt. We had to port that
    code since the default scipy implementation does not return the widths.

    Paramaters
    ----------
    data : array like
        the time series to find the peaks
    widths : array like
        the candidate widths to test

    Returns
    -------
    A list of tripples (peak_volume, peak_width, peak_position). The volume is
    the value of data[peak_position]. The width is the estimated width of the
    wavelet used to find that peak.
    '''
    data = np.asanyarray(data)
    widths = np.asanyarray(widths)

    #These are default values from the scipy port which we based our code on.
    gap_thresh = np.ceil(widths[0])
    max_distances = widths / 4.0

    cwt_dat = cwt(data, ricker, widths)
    ridge_lines = _identify_ridge_lines(cwt_dat, max_distances, gap_thresh)
    filtered = _filter_ridge_lines(cwt_dat, ridge_lines, \
            min_snr=1, noise_perc=1) #noise_perc=1 filters more noise.
    
    #Filtered will be of the form [[peak_widths], [peak_positions]]
    candidates = []
    for x in filtered:
        assert x[0].min() >= 0
        assert x[0].max() < widths.shape[0]

        peak_pos, peak_width = x[1][0], widths[x[0].max()]
        candidates.append((data[peak_pos], peak_width, peak_pos))
    
    return sorted(candidates, reverse=True)

if __name__ == '__main__':

    queen = [6, 14, 7, 121, 115, 48, 24, 26, 33, 45, 23, 37, 23, 12, 28, 33, 17, 12, 16, 12, 7, 19, 18, 22, 12, 39, 90, 103, 51, 70, 67, 64, 88, 55, 78, 104, 93, 97, 98, 119, 138, 79, 92, 91, 74, 64, 53, 73, 84, 69, 64, 92, 73, 61, 79, 77, 98, 106, 127, 107, 102, 111, 96, 75, 57, 42, 32, 19, 27, 41, 45, 60, 32, 58, 47, 44, 57, 67, 65, 70, 58, 58, 54, 66, 62, 74, 77, 63, 69, 36, 59, 69, 96, 59, 46, 61, 43, 62, 76, 77, 98, 62, 124, 277, 256, 325, 342, 279, 346, 353, 338, 374, 416, 480, 399, 471, 355, 392, 332, 376, 450, 358, 350, 317, 336, 421, 411, 466, 375, 414, 446, 468, 407, 472, 449, 418, 341, 358, 343, 385, 436, 457, 356, 414, 402, 411, 314, 512, 492, 352, 335, 413, 474, 416, 420, 452, 448, 498, 443, 402, 365, 363, 359, 262, 366, 283, 275, 297, 304, 370, 313, 318, 328, 371, 406, 512, 511, 406, 395, 422, 427, 473, 427, 515, 397, 404, 441, 496, 531, 642, 756, 641, 600, 627, 568, 730, 768, 856, 765, 698, 647, 650, 709, 714, 750, 608, 498, 467, 463, 562, 562, 580, 415, 457, 307, 290, 384, 625, 539, 436, 372, 561, 590, 765, 930, 915, 868, 709, 363, 376, 459, 445, 729, 597, 511, 602, 460, 602, 679, 564, 468, 473, 428, 467, 439, 553, 687, 623, 480, 451, 521, 489, 506, 479, 474, 469, 596, 1335, 954, 1587, 738, 1398, 2094, 1933, 1929, 2233, 2259, 2303, 1836, 1750, 2074, 3228, 4633, 6139, 5683, 4786, 4520, 4556, 4675, 4803, 4384, 4794, 4021, 4131, 4286, 4308, 3779, 3943, 4142, 4067, 4114, 4592, 6001, 6384, 7343, 6288, 5952, 5867, 5227, 4575, 4807, 4664, 4630, 4319, 4020, 3862, 4149, 4312, 5045, 5277, 5054, 4629, 5022, 4676, 5020, 5515, 5534, 4513, 4167, 5494, 4855, 4406, 4521, 6041, 5508, 4913, 3428, 3701, 3896, 4708, 3926, 3357, 3391, 3246, 3177, 3053, 3625, 3354, 2972, 3027, 3438, 4259, 3910, 3956, 3843, 3160, 3431, 3606, 3641, 4077, 4731, 4612, 4217, 4014, 4157, 4274, 4455, 4885, 4395, 3635, 3733, 3863, 3783, 3689, 3701, 4020, 3121, 3282, 3415, 3322, 3645, 3826, 3588, 3321, 3709, 3377, 2304, 2416, 2568, 2162, 1781, 1109, 1131, 1558, 1686, 2052, 2393, 2021, 1954, 2116, 2107, 2129, 2476, 2426, 1918, 1784, 1412, 1481, 1819, 2312, 2576, 2133, 1979, 1846, 1861, 2032, 2375, 2515, 2116, 1919, 1946, 2017, 2156, 2616, 2622, 2277, 2036, 2101, 2063, 2220, 2367, 2225, 1821, 1879, 1889, 1802, 1902, 2406, 2235, 2131, 1880, 1889, 2019, 2247, 2440, 2642, 2456, 2191, 2114, 2243, 2203, 2661, 2646, 2311, 2085, 2079, 2066, 2025, 2224, 2501, 2166, 2034, 1900, 2139, 2450, 2692, 2689, 1965, 2109, 1662, 2024, 2117, 2479, 2591, 2123, 1950, 1892, 1962, 1899, 2276, 2767, 2496, 2341, 2364, 2356, 2256, 2617, 2710, 2057, 1855, 2764, 3093, 2894, 2910, 3463, 2799, 1908, 2224, 2319, 2358, 2948, 3039, 2189, 1969, 2022, 1779, 1821, 2294, 2337, 1856, 1703, 1740, 1667, 1798, 1950, 2031, 1762, 1730, 1790, 2054, 2202, 1888, 1981, 1961, 1975, 2044, 2258, 2963, 1882, 2078, 1770, 1669, 1752, 1828, 1731, 2160, 2386, 1852, 1649, 1757, 1685, 1690, 2112, 2280, 1794, 1708, 1740, 1440, 1409, 1603, 1628, 1329, 1210, 1336, 1218, 1443, 1695, 1898, 1450, 1322, 1373, 1364, 1402, 2235, 2402, 1833, 1705, 1895, 1977, 1978, 2222, 2407, 1846, 1843, 1827, 1813, 1826, 2087, 2260, 1741, 1655, 1676, 1781, 1781, 2211, 2234, 1916, 1960, 2007, 2218, 8599, 4543, 4376, 3320, 2299, 2654, 3943, 3591, 3539, 3591, 3027, 2358, 2363, 2509, 1849, 2089, 2400, 2145, 1948, 1730, 1966, 2109, 2990, 2523, 2188, 2397, 2767, 2764, 4834, 4599, 4566, 4066, 3968, 3513, 4413, 8939, 10429, 12313, 11632, 14056, 10049, 9460, 9012, 10872, 11734, 9405, 8619, 9060, 14648, 18165, 21223, 19458, 16642, 15409, 15681, 16413, 19943, 23415, 26863, 23065, 21139, 21253, 20132, 19647, 20891, 23644, 20546, 18269, 18130, 18228, 21047, 22184, 22679, 19425, 18344, 17851, 18119, 18201, 20404, 20884, 18825, 17406, 17174, 20258, 33256, 42761, 47244, 39736, 34102, 33535, 34516, 37591, 44699, 48462, 40209, 34126, 38177, 39986, 35508, 35713, 40144, 35008, 29204, 29909, 30277, 32582, 38220, 44041, 36480, 31420, 31786, 32403, 33846, 38349, 41447, 33081, 29430, 29667, 31213, 32905, 34343, 36488, 32915, 31312, 31302, 31205, 33205, 37208, 38730, 32825, 31814, 32815, 29472, 34637, 39798, 42329, 35835, 32690, 33187, 27531, 35739, 39620, 42696, 40120, 38390, 35288, 31252, 37076, 42386, 43363, 31212, 36387, 33080, 35263, 36108, 37949, 42539, 36333, 31871, 28700, 28240, 21399, 24971, 24935, 19591, 18565, 20048, 24448, 25824, 27021, 27115, 24018, 21273, 23267, 22674, 26546, 29792, 30431, 26005, 26035, 25446, 26745, 29167, 30094, 20908, 18295, 16066, 15622, 19594, 30729, 34569, 35449, 30505, 28321, 30079, 32234, 34167, 40566, 44225, 36381, 32513, 33696, 34708, 35029, 41222, 45722, 36511, 31465, 36558, 40279, 47253, 51297, 38413, 38259, 32117, 34446, 36499, 39980, 46176, 51560, 42927, 37727, 36029, 33481, 41114, 46274, 51704, 40948, 35202, 38107, 39149, 39874, 47893, 50033, 41210, 35973, 37836, 37515, 35597, 38044, 47104, 44171, 45835, 38310, 38137, 40504, 48599, 55307, 46133, 39503, 40511, 42484, 49148, 53370, 55858, 46535, 42567, 42034, 37253, 42462, 51387, 56553, 47045, 43162, 43916, 62046, 49820, 52916, 57575, 45271, 40304, 43334, 45161, 44617, 51907, 56193, 46507, 41657, 42673, 44388, 44075, 52302, 56558, 46037, 40692, 43389, 44786, 47569, 50171, 51787, 44973, 42766, 45351, 46433, 50060, 50070, 45597, 43251, 43552, 45441, 45134, 50206, 68043, 48763, 47863, 44305, 46105, 48621, 50236, 58139, 61384, 49736, 43446, 39572, 42370, 46459, 49902, 55631, 45030, 39067, 41491, 42939, 49235, 56549, 58626, 48699, 43550, 43780, 46770, 55343, 59107, 61196, 50904, 43722, 34931, 33968, 47571, 40335, 42949, 33836, 31442, 33430, 33594, 35600, 39876, 42599, 35472, 32167, 32494, 32932, 35638, 42390, 44249, 36850, 32759, 32231, 32636, 34095, 39858, 42711, 34832, 31789, 31172, 31801, 33611, 39428, 42496, 34407, 32108, 32023, 33704, 34580, 37888, 43035, 34715, 32436, 31160, 32342, 33194, 38396, 41247, 35107, 31387, 32262, 35099, 35196, 37126, 41553, 35092, 30455, 30852, 31475, 33087, 37192, 38354, 33175, 30111, 30894, 31889, 32231, 36676, 38893, 31619, 29036, 30289, 31562, 32082, 36642, 38946, 33724, 33058, 31842, 32253, 34909, 36193, 33146, 29903, 27265, 26782, 26984, 29285, 32616, 37927, 32256, 28424, 29172, 30901, 31820, 36862, 39479, 33327, 29294, 30990, 31104, 36084, 43744, 62537, 46049, 33309, 34792, 34113, 37623, 41618, 48376, 42560, 42364, 76312, 64113, 59665, 59237, 58029, 51009, 46009, 45307, 46061, 48240, 52633, 56524, 47048, 42868, 45415, 46365, 46492, 51661, 53205, 46004, 41759, 43105, 45493, 43293, 50614, 51766, 43758, 42037, 42379, 42851, 46727, 49514, 48372, 39860, 37619, 37113, 42769, 47360, 48365, 46334, 39434, 37377, 37957, 39555, 40054, 38345, 44201, 38857, 38686, 38598, 43679, 40526, 47558, 48384, 42564, 41667, 42662, 43290, 44336, 48177, 48649, 42919, 41960, 42431, 42719, 43299, 46942, 46895, 40492, 39722, 40354, 40270, 41063, 45584, 45868, 39784, 37615, 36619, 37475, 38881, 43107, 44594, 40153, 37771, 38193, 37717, 39447, 46105, 46617, 40360, 38335, 42576, 41246, 40682, 47093, 49417, 41635, 39109, 41049, 40486, 43149, 50152, 58076, 94356, 310092, 153708, 83235, 70333, 73214, 73842, 60045, 53295, 52355, 56956, 62092, 71149, 74141, 58006, 52803, 52477, 53839, 62911, 73975, 77561, 60227, 56554, 57618, 55235, 55744, 73337, 75720, 62387, 52746, 53409, 53614, 54599, 64812, 66827, 55907, 48187, 47896, 46431, 46008, 54526, 58298, 49433, 43985, 41110, 46818, 49545, 58855, 63597, 49192, 45933, 45782, 48647, 49598, 56161, 61312, 51096, 48300, 48075, 47255, 49101, 55042, 61400, 53424, 49959, 46463, 48720, 49037, 55641, 61859, 50276, 44004, 44276, 46499, 49783, 58584, 62766, 52409, 48868, 50781, 63206, 164352, 97894, 90289, 67456, 55922, 55964, 55945, 55255, 59261, 61635, 50343, 44752, 46552, 46713, 49090, 53523, 58829, 48974, 42934, 49831, 48780, 48157, 54500, 57689, 47330, 44267, 45905, 57616, 66929, 70746, 75997, 71772, 74749, 67095, 67052, 68738, 77326, 115148, 79808, 68916, 61989, 63817, 68560, 78570, 79940, 67596, 62640, 64680, 67462, 69071, 79662, 85542, 69993, 68812, 82977, 77421, 74516, 84513, 93809, 74590, 67714, 67866, 68738, 72827, 89207, 93555, 69082, 61494, 60490, 60951, 63668, 72094, 80181, 64782, 58037, 63075, 74326, 89055, 96900, 92786, 78974, 71777, 79511, 78742, 79597, 91417, 93892, 77329, 73059, 71527, 71533, 73786, 82908, 89398, 73484, 82706, 77404, 75231, 78340, 86637, 89418, 73777, 69880, 70043, 71372, 71427, 85804, 90965, 73516, 65388, 68666, 69225, 69230, 77914, 85123, 76978, 71083, 69138, 72496, 76741, 84963, 93588, 76185, 67810, 69099, 71616, 109804, 188856, 167012, 114210, 93405, 95505, 105155, 105733, 104540, 99818, 89426, 85923, 80597, 78361, 82854, 87287, 94991, 78793, 71288, 70039, 72593, 76856, 90229, 101922, 87270, 75758, 76399, 91224, 101718, 118736, 121830, 98491, 93438, 87381, 80691, 84821, 93223, 99647, 85512, 76838, 78454, 79159, 83028, 93808, 110245, 92664, 77599, 79286, 82068, 84885, 88907, 89379, 78419, 70508, 78119, 103175, 83837, 91723, 95874, 85715, 78090, 76076, 80315, 83066, 91572, 98116, 85287, 74677, 76313, 78541, 81760, 88000, 91460, 80954, 70421, 79619, 79588, 81823, 90819, 94462, 79194, 71748, 70962, 73019, 72875, 81250, 81112, 68942, 67653, 70678, 66113, 69524, 77446, 78227, 65923, 64469, 67137, 66840, 67855, 75318, 79308, 68472, 70060, 132772, 110192, 96196, 107548, 97042, 96109, 91155, 84522, 75839, 67047, 63144, 80759, 61505, 67793, 69217, 68506, 71518, 101851, 107598, 81595, 82447, 81350, 79153, 77531, 90453, 93054, 73589, 71272, 71413, 69959, 75009, 82058, 82778, 108010, 113402, 105150, 95877, 92169, 98317, 100312, 84710, 80412, 78882, 81261, 85958, 98206, 99996, 86313, 82099, 80405, 79639, 82226, 88072, 92175, 80125, 75845, 77888, 143308, 92955, 95825, 96418, 85738, 77076, 76512, 78971, 87692, 95967, 100848, 80681, 72108, 70088, 72820, 79514, 90493, 97923, 76087, 69188, 72808, 71754, 74010, 85876, 95423, 82799, 75640, 80019, 82789, 107055, 104386, 111869, 87817, 79940, 80198, 82190, 83842, 96271, 105085, 84171, 78414, 75002, 79429, 84385, 96951, 106194, 85602, 78151, 81185, 102391, 108426, 130495, 128693, 106336, 88307, 87279, 87935, 98271, 110380, 119668, 104619, 89184, 83221, 90235, 90585, 102877, 125725, 96461, 89336, 91737, 92896, 94875, 104702, 110547, 93378, 86757, 91602, 95336, 94109, 117706, 150592, 107447, 85301, 89776, 78443, 83011, 97130, 105852, 86704, 77974, 78459, 85340, 94564, 109451, 102964, 83485, 75491, 81160, 82612, 85561, 93173, 105024, 81461, 71861, 82350, 84835, 81600, 91698, 101460, 90262, 94608, 92524, 76627, 80209, 87913, 93060, 89697, 134432, 80855, 75369, 72858, 86698, 94353, 78328, 71949, 76227, 82088, 88726, 90971, 98283, 85251, 83249, 80001, 81987, 87127, 103294, 125874, 97489, 91151, 83665, 101882, 98384, 101889, 118176, 94885, 90583, 89581, 86162, 88016, 103717, 114702, 90509, 85950, 87466, 86555, 87873, 101139, 110065, 92498, 80723, 77654, 80403, 86682, 98837, 114383, 84111, 74372, 55427, 400, 115, 146, 178, 123, 101, 111, 119, 107, 128, 132, 148, 93, 86, 92, 113, 107, 144, 135, 32313, 55494, 45201, 43969, 62411, 79947, 59779, 50892, 51562, 63349, 66713, 72569, 83049, 54493, 44948, 50849, 76248, 83853, 90368, 97443, 94380, 83684, 80276, 80023, 86785, 92427, 102389, 81286, 79652, 83938, 87610, 92545, 103125, 113060, 89897, 77764, 79557, 87354, 85885, 101394, 107225, 92624, 88258, 88196, 89619, 82947, 95889, 105657, 87181, 74855, 82576, 86709, 85687, 99779, 113129, 98900, 81395, 88328, 89847, 91368, 99008, 107261, 88029, 73457, 73571, 78715, 81131, 96143, 97880, 79740, 75902, 73944, 79450, 82547, 90968, 96150, 80236, 72938, 77525, 82815, 83968, 90172, 102266, 82264, 75890, 73887, 78808, 80817, 85991, 97041, 83933, 93880, 87113, 80791, 81744, 90653, 98654, 81699, 73660, 87397, 77840, 83336, 96701, 93341, 74868, 72151, 78227, 83382, 89438, 93948, 90380, 75046, 72098, 75238, 72818, 76239, 77885, 78838, 67334, 65455, 69391, 69240, 75511, 81344, 91360, 74685, 72834, 70710, 78975, 79943, 88896, 87267, 76240, 73783, 76471, 74643, 76783, 86895, 85654, 72621, 71799, 75722, 64416, 59621, 64504, 64043, 57308, 53909, 56921, 57419, 58628, 67370, 68733, 58313, 55054, 58189, 59098, 60490, 65569, 69452, 57210, 56106, 58927, 58827, 60822, 70033, 73885, 61716, 58700, 60666, 59420, 62253, 68544, 72388, 60454, 57377, 61731, 63209, 109891, 81890, 78541, 63788, 54614, 52614, 54986, 57144, 64572, 69461, 60103, 52166, 51836, 52125, 54008, 62734, 67868, 58451, 55118, 54985, 54578, 55870, 64880, 69950, 57548, 48903, 53283, 54820, 57128, 64671, 67928, 57350, 54207, 55522, 56844, 60799, 67110, 74191, 58856, 54497, 52039, 54126, 56965, 67229, 72334, 57288, 53182, 54886, 59484, 66230, 71403, 73881, 62304, 57806, 60512, 60520, 69977, 76193, 78112, 71572, 56718, 58486, 59145, 61717, 71834, 77440, 65931, 59786, 58627, 58974, 62393, 71816, 81122, 63642, 55674, 53871, 62712, 64741, 73533, 84409, 96442, 70022, 63617, 60310, 68319, 77714, 83611, 65657, 66286, 84953, 77168, 78526, 78975, 86815, 85016, 83582, 68029, 66980, 68027, 78963, 79250, 61531, 55945, 62707, 62685, 66903, 72866, 70904, 59857, 61237, 71871, 74891, 62862, 66642, 66468, 59510, 66669, 108167, 61116, 63441, 65540, 71114, 60142, 66775, 65241, 70522, 77819, 79707, 81364, 67111, 67058, 72040, 74715, 74975, 75151, 79900, 65672, 63833, 67505, 65954, 70109, 78877, 79741, 65513, 59650]

    print(find_peaks(queen))
